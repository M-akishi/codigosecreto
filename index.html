<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generador C√≥digo Secreto</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        background: #222;
        color: white;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        width: 350px;
        margin: 20px auto;
        padding: 15px;
        background: #333;
        border-radius: 8px;
      }
      .cell {
        width: 60px;
        height: 60px;
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
      }
      .rojo {
        background-color: #ff4d4d;
      }
      .azul {
        background-color: #4d94ff;
      }
      .cafe {
        background-color: #d2b48c;
      }
      .negro {
        background-color: #1a1a1a;
      }
      .rojo.ocupado {
        background-color: #b12a2a;
      }
      .azul.ocupado {
        background-color: #275395;
      }
      .cafe.ocupado {
        background-color: #d9a867;
      }
      .negro.ocupado {
        background-color: #1a1a1a;
      }
      .cell.ocupado {
        filter: brightness(0.7);
      }
      .cell.ocupado::after {
        content: "‚úñ";
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        font-weight: bold;
        color: rgba(255, 255, 255, 0.9);
        pointer-events: none; /* importante */
      }
      input,
      button {
        padding: 10px;
        border-radius: 5px;
        border: none;
        margin: 5px;
      }
      button {
        background: #27ae60;
        color: white;
        cursor: pointer;
      }
      .cell.pendiente {
        outline: 3px dashed yellow;
        filter: brightness(1.1);
      }
      #manual {
        background: #393939;
        color: white;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h2>Mapa de C√≥digo Secreto</h2>
    <div style="margin-bottom: 20px">
      <label
        >Rojos:
        <input
          type="number"
          id="rojosCount"
          value="9"
          min="1"
          max="9"
          style="width: 40px"
      /></label>
      <label
        >Azules:
        <input
          type="number"
          id="azulesCount"
          value="8"
          min="1"
          max="9"
          style="width: 40px"
      /></label>
      <br />
      <label
        >Negros:
        <input
          type="number"
          id="negrosCount"
          value="1"
          min="1"
          max="7"
          style="width: 40px"
      /></label>
      <br /><br />
      <input type="text" id="seedInput" placeholder="Semilla (ej: qwerty)" />
      <button onclick="generarTablero()">Generar Mapa</button>
    </div>
    <div id="tablero" class="grid"></div>
    <h3 id="seedText"></h3>
    <button id="manual">?</button>
    <script>
      const textoManual = `
üïµÔ∏è C√≥digo Secreto ‚Äì Mapa

‚Ä¢ Genera un mapa usando una semilla
‚Ä¢ Comparte la semilla para repetir el mismo tablero
‚Ä¢ Doble click en una carta para marcarla
‚Ä¢ La partida se guarda mientras la pesta√±a est√© abierta
‚Ä¢ Generar un nuevo mapa borra el actual

‚ö†Ô∏è Si cierras la pesta√±a, la partida termina
`;

      let ultimoClickManual = 0;
      document.getElementById("manual").addEventListener("click", () => {
        const ahora = Date.now();

        if (ahora - ultimoClickManual < 500) {
          alert(textoManual);
          ultimoClickManual = 0;
        } else {
          ultimoClickManual = ahora;
        }
      });

      function aplicarDobleClickCelda(div) {
        let ultimoClick = 0;

        div.addEventListener("click", () => {
          const ahora = Date.now();

          if (ahora - ultimoClick < 500) {
            div.classList.remove("pendiente");
            div.classList.toggle("ocupado");
            guardarEstado();
            ultimoClick = 0;
          } else {
            ultimoClick = ahora;
            div.classList.add("pendiente");

            setTimeout(() => {
              div.classList.remove("pendiente");
            }, 500);
          }
        });
      }

      // Funci√≥n para generar azar basado en una semilla (SFC32)
      function cyrb128(str) {
        let h1 = 1779033703,
          h2 = 3144134277,
          h3 = 1013904242,
          h4 = 2773480762;
        for (let i = 0, k; i < str.length; i++) {
          k = str.charCodeAt(i);
          h1 = h2 ^ Math.imul(h1 ^ k, 597399067);
          h2 = h3 ^ Math.imul(h2 ^ k, 2869860233);
          h3 = h4 ^ Math.imul(h3 ^ k, 951274213);
          h4 = h1 ^ Math.imul(h4 ^ k, 2716044179);
        }
        return [h1 >>> 0, h2 >>> 0, h3 >>> 0, h4 >>> 0];
      }

      function sfc32(a, b, c, d) {
        return function () {
          a >>>= 0;
          b >>>= 0;
          c >>>= 0;
          d >>>= 0;
          var t = (((a + b) | 0) + d) | 0;
          d = (d + 1) | 0;
          a = b ^ (b >>> 9);
          b = (c + (c << 3)) | 0;
          c = (c << 21) | (c >>> 11);
          c = (c + t) | 0;
          return (t >>> 0) / 4294967296;
        };
      }

      function generarTablero() {
        const yaExiste = sessionStorage.getItem("tableroGenerado");

        if (yaExiste) {
          const seguro = confirm(
            "‚ö†Ô∏è ¬øEst√°s seguro de generar otro tablero? Se perder√° el actual."
          );
          if (!seguro) return;

          sessionStorage.removeItem("estadoTablero");
          sessionStorage.removeItem("tableroGenerado");
        }

        const seedText =
          document.getElementById("seedInput").value ||
          Math.random().toString(36).substring(2, 10);
        document.getElementById("seedText").textContent =
          "Semilla usada: " + seedText;

        const seed = cyrb128(seedText);
        const rand = sfc32(seed[0], seed[1], seed[2], seed[3]);
        let numRojos, numAzules, numNegro;

        // Parsear y validar valores (usar radix 10)
        numRojos = Number.parseInt(
          document.getElementById("rojosCount").value,
          10
        );
        numAzules = Number.parseInt(
          document.getElementById("azulesCount").value,
          10
        );
        numNegro = Number.parseInt(
          document.getElementById("negrosCount").value,
          10
        );

        // Manejo de NaN: informar y salir si alg√∫n valor no es num√©rico
        if (
          Number.isNaN(numRojos) ||
          Number.isNaN(numAzules) ||
          Number.isNaN(numNegro)
        ) {
          alert("Solo numeros!");
          return;
        }

        // Normalizar a enteros no negativos (protecci√≥n extra)
        numRojos = Math.max(0, Math.floor(numRojos));
        numAzules = Math.max(0, Math.floor(numAzules));
        numNegro = Math.max(0, Math.floor(numNegro));

        console.log(numRojos, numAzules, numNegro);

        const numCafes = 25 - numRojos - numAzules - numNegro;

        // Validar que no exceda el tablero
        if (numCafes < 0) {
          alert("¬°Demasiadas cartas para un tablero de 25!");
          return;
        }

        // Crear el mazo din√°mico
        let cartas = [
          ...Array(numRojos).fill("rojo"),
          ...Array(numAzules).fill("azul"),
          ...Array(numNegro).fill("negro"),
          ...Array(numCafes).fill("cafe"),
        ];

        // Mezclar (Fisher-Yates)
        for (let i = cartas.length - 1; i > 0; i--) {
          const j = Math.floor(rand() * (i + 1));
          [cartas[i], cartas[j]] = [cartas[j], cartas[i]];
        }

        // Renderizar
        const container = document.getElementById("tablero");
        container.innerHTML = "";
        cartas.forEach((color, index) => {
          const div = document.createElement("div");
          div.className = `cell ${color}`;
          div.id = `cell-${index + 1}`;
          aplicarDobleClickCelda(div);
          container.appendChild(div);
        });

        guardarEstado();
        sessionStorage.setItem("tableroGenerado", "true");
      }

      function guardarEstado() {
        const celdas = document.querySelectorAll(".cell");

        const estado = {
          seed: document.getElementById("seedText").textContent,
          cartas: [...celdas].map((c) =>
            c.classList.contains("rojo")
              ? "rojo"
              : c.classList.contains("azul")
              ? "azul"
              : c.classList.contains("negro")
              ? "negro"
              : "cafe"
          ),
          ocupados: [...celdas].map((c) => c.classList.contains("ocupado")),
        };

        sessionStorage.setItem("estadoTablero", JSON.stringify(estado));
      }

      window.addEventListener("load", () => {
        const estadoGuardado = sessionStorage.getItem("estadoTablero");
        if (!estadoGuardado) return;

        const { cartas, ocupados, seed } = JSON.parse(estadoGuardado);

        const container = document.getElementById("tablero");
        container.innerHTML = "";

        document.getElementById("seedText").textContent = seed;

        cartas.forEach((color, index) => {
          const div = document.createElement("div");
          div.className = `cell ${color}`;
          div.id = `cell-${index + 1}`;

          if (ocupados[index]) {
            div.classList.add("ocupado");
          }

          aplicarDobleClickCelda(div);

          container.appendChild(div);
        });

        sessionStorage.setItem("tableroGenerado", "true");
      });
    </script>
  </body>
</html>
